version: "3.2"

services:
  mailhog:
    image: mailhog/mailhog
    expose:
      - 1025
      - 8025

  db:
    image: ledgersmb/ledgersmb-dev-postgres
    environment:
      POSTGRES_PASSWORD: abc
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - dbdata:/var/lib/postgresql/data

  lsmb:
    depends_on:
      - db
      - selenium
      - mailhog
    user: "${USER}"
    image: ${LSMB_IMAGE:-ledgersmb/ledgersmb-dev-lsmb}
    links:
      - "db:postgres"
    volumes:
      - type: bind
        target: /srv/ledgersmb
        source: ${PWD}
    environment:
      - PLACK_SERVER=HTTP::Server::Simple
      - PERL5OPT
      - HARNESS_PERL_SWITCHES
      - RELEASE_TESTING=1
      - HARNESS_RULESFILE="t/testrules.yml"
      - DEVEL_COVER_OPTIONS
      - LSMB_BASE_URL=http://proxy:80
      - PSGI_BASE_URL=http://lsmb:5762
      - LSMB_TEST_DB=1
      - LSMB_NEW_DB=lsmbtestdb
      - COA_TESTING=1
      - REMOTE_SERVER_ADDR=selenium
      - BROWSER=${BROWSER:-chrome}
      - PGHOST=postgres
      - PGUSER=postgres
      - PGPASSWORD=abc
      - SSMTP_HOSTNAME=mailhog
      - SSMTP_MAILHUB=mailhog:1025

  proxy:
    image: ledgersmb/ledgersmb-dev-nginx
    expose:
      - 5000
    ports:
      - 5000:80
    depends_on:
      - lsmb
    volumes:
      - type: bind
        target: /srv/ledgersmb
        source: ${PWD}

volumes:
  dbdata:
    driver_opts:
      type: tmpfs
      device: tmpfs
